<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dispatch Platform â€“ Driver Portal</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 0;
}
header {
  background: #111;
  color: #fff;
  padding: 15px;
  text-align: center;
}
.container {
  max-width: 900px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
}
input, textarea, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
}
button {
  background: #1a73e8;
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
button:hover {
  background: #155bb5;
}
.section {
  margin-top: 30px;
  border-top: 1px solid #ddd;
  padding-top: 20px;
}
.hidden { display: none; }
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCuVHO6lV4URp_c-b28wzJ7FLKsex5HlYI",
  authDomain: "dispatch-platform-6e7f1.firebaseapp.com",
  projectId: "dispatch-platform-6e7f1",
  storageBucket: "dispatch-platform-6e7f1.firebasestorage.app",
  messagingSenderId: "997904614665",
  appId: "1:997904614665:web:7e475c06b131ff2ee8bfd8"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
</script>
</head>

<body>

<header>
  <h1>Driver Portal</h1>
</header>

<div class="container">

<!-- AUTH -->
<div id="authSection">
  <h2>Driver Sign Up / Login</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
  <h2>Driver Dashboard</h2>

  <div class="section">
    <h3>Driver Profile</h3>
    <input id="truck" placeholder="Truck & Trailer Info">
    <input id="home" placeholder="Home City & State">
    <input id="minCost" type="number" placeholder="Minimum Cost per Mile">
    <input id="minProfit" type="number" placeholder="Minimum Profit %">
  </div>

  <div class="section">
    <h3>Preferences</h3>
    <input id="sleep" placeholder="Sleeping until (ex: 3:00 PM)">
    <input id="wakePay" type="number" placeholder="Wake me if load pays at least $">
    <input id="noStates" placeholder="States I avoid">
    <input id="weight" type="number" placeholder="Max weight (lbs)">
    <textarea id="noLoads" placeholder="Loads I refuse"></textarea>
  </div>

  <button onclick="saveProfile()">Save Profile</button>
  <button onclick="logout()">Logout</button>
</div>

</div>

<script>
function signup() {
  auth.createUserWithEmailAndPassword(
    email.value,
    password.value
  ).catch(err => alert(err.message));
}

function login() {
  auth.signInWithEmailAndPassword(
    email.value,
    password.value
  ).catch(err => alert(err.message));
}

function logout() {
  auth.signOut();
}

auth.onAuthStateChanged(user => {
  if (user) {
    authSection.classList.add("hidden");
    dashboard.classList.remove("hidden");

    const ref = db.collection("drivers").doc(user.uid);

    // Ensure base driver record exists
    ref.set({
      uid: user.uid,
      email: user.email,
      role: "driver",
      status: "active",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // ðŸ”‘ LOAD EXISTING PROFILE DATA
    ref.get().then(doc => {
      if (doc.exists) {
        const d = doc.data();
        truck.value = d.truck || "";
        home.value = d.home || "";
        minCost.value = d.minCost || "";
        minProfit.value = d.minProfit || "";
        sleep.value = d.sleep || "";
        wakePay.value = d.wakePay || "";
        noStates.value = d.noStates || "";
        weight.value = d.weight || "";
        noLoads.value = d.noLoads || "";
      }
    });

  } else {
    authSection.classList.remove("hidden");
    dashboard.classList.add("hidden");
  }
});

function saveProfile() {
  const user = auth.currentUser;
  if (!user) return;

  db.collection("drivers").doc(user.uid).update({
    truck: truck.value,
    home: home.value,
    minCost: minCost.value,
    minProfit: minProfit.value,
    sleep: sleep.value,
    wakePay: wakePay.value,
    noStates: noStates.value,
    weight: weight.value,
    noLoads: noLoads.value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => alert("Profile saved to Firestore âœ…"))
  .catch(err => alert(err.message));
}
</script>

</body>
</html>
